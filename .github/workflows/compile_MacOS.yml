name: Build macOS App

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-macos-app:
    name: Build BitChat macOS .app
    runs-on: macos-13

    steps:
    # ✅ Step 1: Checkout the repo
    - name: Checkout repository
      uses: actions/checkout@v4

    # ✅ Step 2: Set up Xcode (use latest available on GitHub runner)
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
      # Note: 16.x is not available on hosted runners as of now.
      # You can check available versions here: https://github.com/actions/runner-images/blob/main/images/macos/macos-13-Readme.md

    # ✅ Step 3: Install XcodeGen
    - name: Install XcodeGen
      run: brew install xcodegen

    # ✅ Step 4: Generate Xcode project
    - name: Generate Xcode project
      run: xcodegen generate

    # ✅ Step 5: Build macOS app
    - name: Build macOS .app
      run: |
        xcodebuild \
          -project bitchat.xcodeproj \
          -scheme "bitchat (macOS)" \
          -configuration Release \
          -derivedDataPath build

    # ✅ Step 6: Copy .app to dist/
    - name: Prepare .app for upload
      run: |
        mkdir -p dist
        APP_PATH=$(find build/Build/Products/Release -name "*.app" -type d | head -n 1)
        echo "Found .app at: $APP_PATH"
        cp -R "$APP_PATH" dist/

    # ✅ Step 7: Upload artifact
    - name: Upload .app artifact
